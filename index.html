<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Jacky's Birthday Coffee Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a1a1a;
        font-family: 'Press Start 2P', cursive;
        touch-action: none; /* Prevents unwanted zooming/scrolling on mobile */
        color: white;
        user-select: none;
        -webkit-user-select: none;
      }
      #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(#1e3f20, #0a1f0d);
      }
      canvas {
        background-color: #3b2818;
        border: 6px solid #000;
        box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.5);
        image-rendering: pixelated;
        max-width: 95%;
        max-height: 55vh; /* Adjusted slightly to make room for bigger d-pad */
      }

      /* Pixel Art UI Styles */
      .pixel-panel {
        background-color: #006241;
        border: 4px solid #fff;
        box-shadow: 6px 6px 0px #000;
        padding: 20px;
        text-align: center;
      }
      .pixel-btn {
        background-color: #2b1d14;
        border: 4px solid #fff;
        box-shadow: 4px 4px 0px #000;
        color: white;
        padding: 15px 20px;
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        line-height: 1.5;
        text-transform: uppercase;
        cursor: pointer;
        margin-top: 20px;
      }
      .pixel-btn:active {
        transform: translate(4px, 4px);
        box-shadow: 0px 0px 0px #000;
      }

      /* Mobile D-Pad Styles - MADE BIGGER FOR BETTER MOBILE PLAY */
      #dpad {
        display: grid;
        grid-template-columns: repeat(3, 80px); /* Increased size */
        grid-template-rows: repeat(3, 80px); /* Increased size */
        gap: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .dpad-btn {
        background-color: #d4b895;
        border: 4px solid #000;
        box-shadow: 4px 4px 0px #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px; /* Bigger Arrows */
        color: #000;
        user-select: none;
        -webkit-user-select: none;
        cursor: pointer;
        z-index: 10;
        touch-action: none;
      }
      .dpad-btn:active,
      .dpad-btn.active {
        transform: translate(4px, 4px);
        box-shadow: 0px 0px 0px #000;
        background-color: #b09676;
      }
      #btn-up {
        grid-column: 2;
        grid-row: 1;
      }
      #btn-left {
        grid-column: 1;
        grid-row: 2;
      }
      #btn-right {
        grid-column: 3;
        grid-row: 2;
      }
      #btn-down {
        grid-column: 2;
        grid-row: 3;
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
      }
      .hidden {
        display: none !important;
      }

      #ui-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        z-index: 5;
        font-size: 10px;
        color: white;
        text-shadow: 2px 2px 0px #000;
      }

      .title-text {
        color: #4ade80;
        text-shadow: 4px 4px 0px #000;
        font-size: 24px;
        line-height: 1.5;
        margin-bottom: 20px;
      }
      .body-text {
        font-size: 10px;
        line-height: 1.8;
        max-width: 400px;
        margin-bottom: 20px;
        color: #e5e7eb;
      }

      /* Dialog Box (Pokemon Style) */
      #dialog-box {
        position: absolute;
        bottom: 20%;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 500px;
        background-color: #f8f9fa;
        border: 6px solid #2b1d14;
        box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 15px;
        z-index: 20;
        color: #000;
        cursor: pointer;
      }
      #dialog-name {
        color: #006241;
        font-size: 12px;
        margin-bottom: 10px;
        text-transform: uppercase;
        text-shadow: 1px 1px 0px #ccc;
      }
      #dialog-text {
        font-size: 10px;
        line-height: 1.6;
      }
      .dialog-prompt {
        text-align: right;
        font-size: 8px;
        color: #888;
        margin-top: 10px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <div id="ui-bar" class="hidden">
        <span id="level-display">RM:1</span>
        <span id="bean-display">BEANS:0/33</span>
        <span id="life-display">☕☕☕☕☕</span>
      </div>

      <canvas id="gameCanvas" width="600" height="400"></canvas>

      <!-- Dialog UI -->
      <div id="dialog-box" class="hidden">
        <div id="dialog-name" class="font-bold">Name</div>
        <div id="dialog-text">Text goes here...</div>
        <div class="dialog-prompt">Tap to continue ▼</div>
      </div>

      <!-- Mobile Controls -->
      <div id="dpad">
        <div class="dpad-btn" id="btn-up">▲</div>
        <div class="dpad-btn" id="btn-left">◀</div>
        <div class="dpad-btn" id="btn-right">▶</div>
        <div class="dpad-btn" id="btn-down">▼</div>
      </div>

      <!-- Start Screen -->
      <div id="start-screen" class="overlay">
        <div class="pixel-panel">
          <h1 class="title-text">JACKY'S<br />COFFEE RUN V 1.1</h1>
          <p
            class="body-text"
            style="
              font-size: 12px;
              margin-bottom: 10px;
              color: #fde047;
              text-align: center;
            ">
            HOW TO PLAY:
          </p>
          <p class="body-text" style="text-align: center; line-height: 1.5">
            1. Help Jacky collect 33 beans.<br />2. Use D-Pad or Arrow Keys.<br />3.
            Dodge cheesecakes, ensaymadas & baristas.<br />4. You have 5 Cups
            (Lives).<br />5. Beware of the Boss!
          </p>
          <button id="start-btn" class="pixel-btn">START GAME</button>
        </div>
      </div>

      <!-- Level Transition Screen -->
      <div id="transition-screen" class="overlay hidden">
        <div class="pixel-panel">
          <h1 class="title-text" id="transition-title">ROOM CLEARED!</h1>
          <p class="body-text">You're getting closer to the surprise!</p>
          <button id="next-level-btn" class="pixel-btn">ENTER NEXT ROOM</button>
        </div>
      </div>

      <!-- Win Screen -->
      <div id="win-screen" class="overlay hidden">
        <div class="pixel-panel" style="width: 90%; max-width: 500px">
          <h1
            class="title-text"
            style="color: #fde047; font-size: 20px; line-height: 1.5">
            Happy Birthday<br />Ma'am Jack!
          </h1>
          <p
            class="body-text"
            style="
              font-size: 12px;
              color: #86efac;
              margin-bottom: 30px;
              line-height: 2;
              text-align: center;
              margin-left: auto;
              margin-right: auto;
            ">
            FROM ICLC FAMILY<br />and Coffee Buddies!
          </p>
          <div style="display: flex; justify-content: center">
            <button
              id="exit-btn"
              class="pixel-btn"
              style="background-color: #991b1b; margin-top: 0">
              EXIT GAME
            </button>
          </div>
        </div>
      </div>

      <!-- Game Over Screen -->
      <div id="game-over-screen" class="overlay hidden">
        <div class="pixel-panel">
          <h1 class="title-text" style="color: #ef4444">GAME OVER</h1>
          <p class="body-text">You ran out of coffee cups!</p>
          <button id="try-again-btn" class="pixel-btn">TRY AGAIN</button>
          <button
            id="game-over-exit-btn"
            class="pixel-btn"
            style="background-color: #991b1b; margin-left: 10px">
            EXIT GAME
          </button>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      // UI Elements
      const startScreen = document.getElementById('start-screen');
      const transitionScreen = document.getElementById('transition-screen');
      const winScreen = document.getElementById('win-screen');
      const uiBar = document.getElementById('ui-bar');
      const beanDisplay = document.getElementById('bean-display');
      const levelDisplay = document.getElementById('level-display');
      const lifeDisplay = document.getElementById('life-display');
      const dialogBox = document.getElementById('dialog-box');
      const dialogName = document.getElementById('dialog-name');
      const dialogText = document.getElementById('dialog-text');
      const gameOverScreen = document.getElementById('game-over-screen');

      let gameState = 'START'; // START, PLAYING, DIALOG, TRANSITION, WIN, GAMEOVER
      let currentLevel = 0;
      let totalBeansCollected = 0;
      let bossSpawned = false;
      let screenShake = 0;
      let lives = 5;
      const keys = {
        w: false,
        a: false,
        s: false,
        d: false,
        ArrowUp: false,
        ArrowDown: false,
        ArrowLeft: false,
        ArrowRight: false,
      };

      // --- AUDIO / MUSIC SYSTEM (Web Audio API) ---
      let audioCtx;
      let bgmInterval;
      let noteIndex = 0;

      function initAudio() {
        if (!audioCtx)
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }

      function playNote(freq, type, duration, vol) {
        if (!audioCtx) return;
        try {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
          gain.gain.setValueAtTime(vol, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + duration,
          );
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + duration);
        } catch (e) {}
      }

      function startNormalMusic() {
        initAudio();
        if (bgmInterval) clearInterval(bgmInterval);
        noteIndex = 0;
        // Happy, upbeat 8-bit chip-tune sequence
        bgmInterval = setInterval(() => {
          if (gameState !== 'PLAYING' && gameState !== 'DIALOG') return;
          const notes = [261.63, 329.63, 392.0, 523.25, 392.0, 329.63]; // C4, E4, G4, C5, G4, E4
          playNote(notes[noteIndex % notes.length], 'square', 0.15, 0.02);
          noteIndex++;
        }, 200);
      }

      function startBossMusic() {
        initAudio();
        if (bgmInterval) clearInterval(bgmInterval);
        noteIndex = 0;
        // Scary, slow, dissonant low rumble
        bgmInterval = setInterval(() => {
          if (gameState !== 'PLAYING' && gameState !== 'DIALOG') return;
          const notes = [65.41, 69.3]; // Low C, C#
          playNote(notes[noteIndex % notes.length], 'sawtooth', 0.6, 0.06);
          noteIndex++;
        }, 600);
      }

      function startHappyMusic() {
        initAudio();
        if (bgmInterval) clearInterval(bgmInterval);
        noteIndex = 0;
        // Joyful, happy melody for the VIP room
        bgmInterval = setInterval(() => {
          if (
            gameState !== 'PLAYING' &&
            gameState !== 'DIALOG' &&
            gameState !== 'WIN'
          )
            return;
          const notes = [523.25, 659.25, 783.99, 1046.5, 783.99, 659.25]; // C5 E5 G5 C6 G5 E5
          playNote(notes[noteIndex % notes.length], 'sine', 0.15, 0.03);
          noteIndex++;
        }, 180);
      }

      function stopMusic() {
        if (bgmInterval) clearInterval(bgmInterval);
      }

      function playDamageSound() {
        initAudio();
        playNote(150, 'sawtooth', 0.3, 0.05); // Zap sound
      }

      // --- DIALOG SYSTEM ---
      let dialogQueue = [];
      let onDialogComplete = null;

      function startDialog(dialogs, callback) {
        dialogQueue = [...dialogs];
        onDialogComplete = callback;
        gameState = 'DIALOG';
        keys.w =
          keys.a =
          keys.s =
          keys.d =
          keys.ArrowUp =
          keys.ArrowDown =
          keys.ArrowLeft =
          keys.ArrowRight =
            false; // Stop movement
        showNextDialogLine();
      }

      function showNextDialogLine() {
        if (dialogQueue.length === 0) {
          dialogBox.classList.add('hidden');
          gameState = 'PLAYING';
          if (onDialogComplete) onDialogComplete();
          return;
        }
        const line = dialogQueue.shift();
        dialogBox.classList.remove('hidden');
        dialogName.innerText = line.name || 'Jacky';
        dialogText.innerText = line.text;
      }

      // Tap anywhere or press any key during dialog to advance
      const handleDialogAdvance = (e) => {
        if (gameState === 'DIALOG') {
          e.preventDefault();
          showNextDialogLine();
        }
      };
      document
        .getElementById('game-container')
        .addEventListener('pointerdown', handleDialogAdvance);

      // --- PIXEL ART ENGINE ---
      const colors = {
        0: '#000000', // Black Outline
        1: '#ffccaa', // Skin
        2: '#4a2511', // Dark Brown (Jacky's Hair)
        3: '#00704A', // Starbucks Green
        4: '#225588', // Jeans Blue
        5: '#ffffff', // White
        6: '#d4af37', // Blonde hair
        7: '#8c593b', // Bean dark / wood
        8: '#aaaaaa', // Gray Cart / Bat
        g: '#8bc34a', // Jacky's Green Clothes
        v: '#8e24aa', // Boss Leah's Purple Clothes
        a: '#87ceeb', // Glasses frame (Light Blue)
        b: '#333333', // Husband suit (Dark Gray)
        c: '#ff9900', // Candle flame
        p: '#2e8b57', // Plant green
        e: '#fffdd0', // Cheesecake cream
        f: '#e53935', // Cherry red
        s: '#fbbf24', // Ensaymada cheese
        '.': 'transparent',
      };

      // Jacky Sprites (Directional)
      const sprJackyDown = [
        '............',
        '...000000...',
        '..02222220..',
        '.0221111220.',
        '.0000110000.', // Thick black upper frames
        '.0550110550.', // Black outer frame with white glasses lenses
        '.0222222220.', // Long hair flowing
        '.020gggg020.', // Green clothes
        '.020gggg020.', // Green clothes
        '..02444420..',
        '...040040...',
        '...00..00...',
      ];

      const sprJackyUp = [
        '............',
        '...000000...',
        '..02222220..',
        '.0222222220.',
        '.0222222220.',
        '.0222222220.',
        '.0222222220.',
        '.020gggg020.',
        '.020gggg020.',
        '..02444420..',
        '...040040...',
        '...00..00...',
      ];

      const sprJackySide = [
        '............',
        '...000000...',
        '..02222220..',
        '.022211110..',
        '.020000100..', // side glasses frame
        '.020550150..', // side lenses
        '.022222220..',
        '.020gggg0...',
        '.020gggg0...',
        '..0244440...',
        '...04000....',
        '...00.......',
      ];

      // BOSS LEAH Sprites (Directional)
      const sprLeahDown1 = [
        '...000000.8.',
        '..022222208.',
        '.02211112208',
        '.02211112208',
        '.020vvvv0208', // Bat held up + Purple
        '.020vvvv0008',
        '..00vvvv000.',
        '.010vvvv080.',
        '.000vvvv000.',
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprLeahDown2 = [
        '...000000...',
        '..02222220..',
        '.0221111220.',
        '.0221111220.',
        '.020vvvv020.',
        '.020vvvv000.',
        '..00vvvv000.',
        '.010vvvv000.',
        '.000vvvv0888', // Bat swinging out horizontally
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprLeahUp1 = [
        '...000000.8.',
        '..022222208.',
        '.02222222208',
        '.02222222208',
        '.020vvvv0208',
        '.020vvvv0008',
        '..00vvvv000.',
        '..00vvvv000.',
        '.000vvvv000.',
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprLeahUp2 = [
        '...000000...',
        '..02222220..',
        '.0222222220.',
        '.0222222220.',
        '.020vvvv020.',
        '.020vvvv000.',
        '..00vvvv000.',
        '..00vvvv000.',
        '.000vvvv0888',
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprLeahSide1 = [
        '.....000000.8',
        '....022222208',
        '...0222111108',
        '...0200001008',
        '...020vvvv008', // Bat side
        '...020vvvv008',
        '....00vvvv00.',
        '....010vvvv0.',
        '....000vvvv0.',
        '.....044440..',
        '......00..0..',
        '.............',
      ];
      const sprLeahSide2 = [
        '.....000000..',
        '....02222220.',
        '...022211110.',
        '...020000100.',
        '...020vvvv00.',
        '...020vvvv00.',
        '....00vvvv00.',
        '....010vvvv0.',
        '....000vvvv0888', // Bat swing
        '.....044440..',
        '......00..0..',
        '.............',
      ];

      // Barista Sprites (Directional)
      const sprBaristaDown = [
        '...000000...',
        '..03333330..',
        '..00333300..',
        '...011110...',
        '...010010...',
        '...011110...',
        '..00055000..',
        '.0103333010.',
        '.0003333000.',
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprBaristaUp = [
        '...000000...',
        '..03333330..',
        '..00333300..',
        '...022220...',
        '...022220...',
        '...022220...',
        '..00055000..',
        '.0003333000.',
        '.0003333000.',
        '...044440...',
        '...00..00...',
        '............',
      ];
      const sprBaristaSide = [
        '.....000000.',
        '....03333330',
        '....00333300',
        '.....011110.',
        '.....010000.',
        '.....011110.',
        '....0005500.',
        '...01033330.',
        '...00033330.',
        '....0044440.',
        '.....00..0..',
        '............',
      ];

      const sprBean = [
        '............',
        '............',
        '....0000....',
        '...077770...',
        '..07722770..',
        '..07227770..',
        '..07777770..',
        '...000000...',
        '............',
        '............',
        '............',
        '............',
      ];

      const sprCheesecake = [
        '............',
        '............',
        '....0000....',
        '...0ffff0...',
        '..0eeeeee0..',
        '.0eeeeeeee0.',
        '.0eeeeeeee0.',
        '.0eeeeeeee0.',
        '.0777777770.',
        '..00000000..',
        '............',
        '............',
      ];

      const sprEnsaymada = [
        '............',
        '....0000....',
        '..00ssss00..',
        '.0ssssssss0.',
        '.0s5s5s5ss0.',
        '.0666666660.',
        '.0666666660.',
        '.0666666660.',
        '..07777770..',
        '...000000...',
        '............',
        '............',
      ];

      const sprHusband = [
        '...000000...',
        '..02222220..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '...000000...',
        '..00b55b00..',
        '.010bbbb010.',
        '.000bbbb000.',
        '...0bbbb0...',
        '...00..00...',
        '............',
      ];

      const sprFriend1 = [
        '............',
        '...000000...',
        '..06666660..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '..00888800..',
        '.0108888010.',
        '.0004444000.',
        '...044440...',
        '...00..00...',
        '............',
      ];

      const sprFriend2 = [
        '............',
        '...000000...',
        '..02222220..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '..00cccc00..',
        '.010cccc010.',
        '.000bbbb000.',
        '...0bbbb0...',
        '...00..00...',
        '............',
      ];

      const sprPlant = [
        '............',
        '....pppp....',
        '...pppppp...',
        '..pppppppp..',
        '...pppppp...',
        '....pppp....',
        '.....22.....',
        '....0000....',
        '...088880...',
        '...088880...',
        '....0000....',
        '............',
      ];

      const sprTable = [
        '............',
        '............',
        '............',
        '.0000000000.',
        '.0777777770.',
        '.0777777770.',
        '.0000000000.',
        '...02..20...',
        '...02..20...',
        '...02..20...',
        '...00..00...',
        '............',
      ];

      const sprChair = [
        '............',
        '...000000...',
        '...077770...',
        '...077770...',
        '...000000...',
        '....0..0....',
        '....0..0....',
        '............',
        '............',
        '............',
        '............',
        '............',
      ];

      const sprDoor = [
        '............',
        '..00000000..',
        '.0777777770.',
        '.0777777770.',
        '.0777777770.',
        '.0777777770.',
        '.0777777770.',
        '.0777777770.',
        '.0777777670.',
        '.0777777770.',
        '.0777777770.',
        '............',
      ];

      const sprArrow = [
        '............',
        '.....00.....',
        '....0550....',
        '...055550...',
        '..05555550..',
        '.0555555550.',
        '..00055000..',
        '....0550....',
        '....0550....',
        '....0550....',
        '....0000....',
        '............',
      ];

      function drawSprite(spriteArray, x, y, size, flipX = false) {
        const pixelSize = size / 12; // 12x12 grid
        for (let row = 0; row < 12; row++) {
          for (let col = 0; col < 12; col++) {
            const char = spriteArray[row][col];
            if (char !== '.') {
              ctx.fillStyle = colors[char];
              let px = flipX ? 11 - col : col;
              ctx.fillRect(
                x + px * pixelSize,
                y + row * pixelSize,
                pixelSize,
                pixelSize,
              );
            }
          }
        }
      }

      function drawSpriteRotated(spriteArray, x, y, size, angle) {
        ctx.save();
        ctx.translate(x + size / 2, y + size / 2);
        ctx.rotate(angle);
        drawSprite(spriteArray, -size / 2, -size / 2, size, false);
        ctx.restore();
      }

      // --- GAME ENTITIES & LOGIC ---

      const player = {
        x: 50,
        y: 200,
        size: 48,
        speed: 4,
        direction: 'down',
        hitbox: { xOffset: 12, yOffset: 16, w: 24, h: 24 },
        isHit: false,
        exitActive: false,
        invincible: false,
        invincibleTimer: 0,
      };

      let beans = [];
      let obstacles = [];
      let scenery = [];
      let friends = [];

      const levels = [
        {
          name: 'Outside Cafe',
          intro: [
            {
              name: 'Jacky',
              text: 'Welcome to Starbucks Roosevelt! I need to collect the 11 coffee beans scattered outside first.',
            },
            {
              name: 'Jacky',
              text: 'I better watch out for those wild cheesecakes!',
            },
          ],
          startX: 50,
          startY: 200,
          exit: { x: 552, y: 176, type: 'right' },
          beans: [
            { x: 150, y: 100 },
            { x: 250, y: 100 },
            { x: 350, y: 100 },
            { x: 450, y: 100 },
            { x: 150, y: 300 },
            { x: 250, y: 300 },
            { x: 350, y: 300 },
            { x: 450, y: 300 },
            // 3 additional beans
            { x: 250, y: 200 },
            { x: 300, y: 200 },
            { x: 350, y: 200 },
          ],
          obstacles: [
            {
              x: 200,
              y: 50,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.2,
              sprite: sprCheesecake,
              type: 'random',
              timer: 0,
              minX: 20,
              maxX: 550,
              minY: 20,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
            {
              x: 400,
              y: 350,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.2,
              sprite: sprCheesecake,
              type: 'random',
              timer: 0,
              minX: 20,
              maxX: 550,
              minY: 20,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
            // Added more enemies
            {
              x: 300,
              y: 150,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.0,
              sprite: sprCheesecake,
              type: 'random',
              timer: 0,
              minX: 20,
              maxX: 550,
              minY: 20,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
            {
              x: 500,
              y: 100,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.3,
              sprite: sprCheesecake,
              type: 'random',
              timer: 0,
              minX: 20,
              maxX: 550,
              minY: 20,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
            {
              x: 100,
              y: 250,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.1,
              sprite: sprCheesecake,
              type: 'random',
              timer: 0,
              minX: 20,
              maxX: 550,
              minY: 20,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
          ],
          scenery: [
            { x: 20, y: 20, size: 48, sprite: sprPlant },
            { x: 530, y: 20, size: 48, sprite: sprPlant },
            { x: 20, y: 330, size: 48, sprite: sprPlant },
            { x: 530, y: 330, size: 48, sprite: sprPlant },
            { x: 150, y: 200, size: 48, sprite: sprTable },
            { x: 110, y: 200, size: 48, sprite: sprChair },
            { x: 450, y: 200, size: 48, sprite: sprTable },
            { x: 490, y: 200, size: 48, sprite: sprChair },
          ],
          friends: [],
        },
        {
          name: 'The Lounge',
          intro: [
            {
              name: 'Jacky',
              text: 'The restaurant lounge. More beans to collect here!',
            },
            {
              name: 'Jacky',
              text: 'Those wild ensaymadas look dangerous. Better dodge them.',
            },
          ],
          startX: 50,
          startY: 200,
          exit: { x: 276, y: 352, type: 'bottom' },
          beans: [
            { x: 100, y: 50 },
            { x: 200, y: 50 },
            { x: 300, y: 50 },
            { x: 400, y: 50 },
            { x: 100, y: 350 },
            { x: 200, y: 350 },
            { x: 300, y: 350 },
            { x: 400, y: 350 },
            // 3 additional beans
            { x: 100, y: 200 },
            { x: 350, y: 200 },
            { x: 500, y: 150 },
          ],
          obstacles: [
            {
              x: 100,
              y: 150,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.5,
              sprite: sprEnsaymada,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
            {
              x: 500,
              y: 250,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.5,
              sprite: sprEnsaymada,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
            // Added more enemies
            {
              x: 300,
              y: 50,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.3,
              sprite: sprEnsaymada,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
            {
              x: 400,
              y: 100,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.4,
              sprite: sprEnsaymada,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
            {
              x: 200,
              y: 300,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.2,
              sprite: sprEnsaymada,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
          ],
          scenery: [
            { x: 250, y: 150, size: 48, sprite: sprTable },
            { x: 250, y: 110, size: 48, sprite: sprChair },
            { x: 250, y: 250, size: 48, sprite: sprTable },
            { x: 250, y: 290, size: 48, sprite: sprChair },
            { x: 450, y: 80, size: 48, sprite: sprPlant },
            { x: 150, y: 300, size: 48, sprite: sprPlant },
          ],
          friends: [],
        },
        {
          name: 'The Counter',
          intro: [
            {
              name: 'Jacky',
              text: 'The main counter! I have to walk around it to get the last beans.',
            },
            {
              name: 'Jacky',
              text: "The baristas are walking around randomly making orders. Let's take it slow.",
            },
          ],
          startX: 276,
          startY: 80,
          exit: { x: 276, y: 0, type: 'top' },
          beans: [
            { x: 150, y: 50 },
            { x: 250, y: 50 },
            { x: 350, y: 50 },
            { x: 450, y: 50 },
            { x: 150, y: 300 },
            { x: 250, y: 300 },
            { x: 350, y: 300 },
            { x: 450, y: 300 },
            // 3 additional beans
            { x: 50, y: 150 },
            { x: 500, y: 150 },
            { x: 50, y: 250 },
          ],
          obstacles: [
            {
              x: 150,
              y: 100,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 0.9,
              sprite: sprBaristaDown,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            {
              x: 450,
              y: 300,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 0.9,
              sprite: sprBaristaDown,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            {
              x: 300,
              y: 250,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 0.9,
              sprite: sprBaristaDown,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            {
              x: 150,
              y: 170,
              size: 48,
              dx: 0,
              dy: 0,
              type: 'static_counter',
              hitbox: { xOffset: 0, yOffset: 0, w: 300, h: 60 },
            },
          ],
          scenery: [
            { x: 30, y: 20, size: 48, sprite: sprPlant },
            { x: 520, y: 320, size: 48, sprite: sprPlant },
            { x: 500, y: 220, size: 48, sprite: sprTable },
            { x: 500, y: 260, size: 48, sprite: sprChair },
          ],
          friends: [],
        },
        {
          name: 'VIP Room',
          intro: [
            { name: 'Jacky', text: "Wait... the VIP room? Who's in here?" },
            {
              name: 'Jacky',
              text: 'I need to come closer to the people to talk...',
            },
          ],
          startX: 276,
          startY: 330,
          beans: [],
          obstacles: [],
          scenery: [
            { x: 100, y: 50, size: 48, sprite: sprPlant },
            { x: 100, y: 300, size: 48, sprite: sprPlant },
            { x: 450, y: 50, size: 48, sprite: sprPlant },
            { x: 450, y: 300, size: 48, sprite: sprPlant },
            { x: 380, y: 150, size: 48, sprite: sprTable },
          ],
          friends: [
            { name: 'Jose', x: 450, y: 200, size: 48, sprite: sprHusband },
            {
              name: 'Don Joseph',
              x: 400,
              y: 130,
              size: 48,
              sprite: sprFriend1,
            },
            { name: 'Jay', x: 400, y: 270, size: 48, sprite: sprFriend2 },
          ],
        },
      ];

      function loadLevel(levelIndex) {
        const lvl = levels[levelIndex];
        player.x = lvl.startX;
        player.y = lvl.startY;
        player.direction = 'down';
        player.isHit = false;
        player.exitActive = false;
        player.invincible = false;
        player.invincibleTimer = 0;
        bossSpawned = false;

        beans = lvl.beans.map((b) => ({
          ...b,
          size: 24,
          collected: false,
          hitbox: { xOffset: 0, yOffset: 0, w: 24, h: 24 },
        }));
        obstacles = lvl.obstacles.map((o) => ({
          ...o,
          opacity: 1.0,
          fading: false,
          dead: false,
          direction: 'down',
        }));

        // Add hitboxes to scenery for collision blocking
        scenery = lvl.scenery
          ? lvl.scenery.map((s) => ({
              ...s,
              hitbox: {
                xOffset: 6,
                yOffset: 12,
                w: s.size - 12,
                h: s.size - 18,
              }, // slightly smaller hitbox allows walking "behind" plants/tables
            }))
          : [];

        friends = lvl.friends.map((f) => ({
          ...f,
          hitbox: { xOffset: 0, yOffset: 0, w: 48, h: 48 },
        }));

        levelDisplay.innerText = `RM:${levelIndex + 1}`;
        updateUI();

        // Start level intro dialog
        if (lvl.intro && lvl.intro.length > 0) {
          startDialog(lvl.intro, null);
        }

        // Restart normal music if loading a level and boss hasn't spawned
        if (gameState !== 'START') {
          if (levelIndex === 3) {
            startHappyMusic();
          } else if (!bossSpawned) {
            startNormalMusic();
          }
        }
      }

      function updateUI() {
        beanDisplay.innerText = `BEANS:${totalBeansCollected}/33`;
        lifeDisplay.innerText = '☕'.repeat(lives > 0 ? lives : 0);
      }

      // Input Handling
      window.addEventListener('keydown', (e) => {
        // Convert to lowercase so WASD works even if Caps Lock is on
        const k = e.key.length === 1 ? e.key.toLowerCase() : e.key;
        if (keys.hasOwnProperty(k)) keys[k] = true;
        if (gameState === 'DIALOG' && (k === ' ' || k === 'Enter'))
          handleDialogAdvance(e);
      });
      window.addEventListener('keyup', (e) => {
        const k = e.key.length === 1 ? e.key.toLowerCase() : e.key;
        if (keys.hasOwnProperty(k)) keys[k] = false;
      });

      // MOBILE CONTROLS UPDATED: Using Pointer Events for 100% smooth holds without stuttering
      const setupDpad = (btnId, keyName1, keyName2) => {
        const btn = document.getElementById(btnId);
        const press = (e) => {
          e.preventDefault();
          if (gameState === 'DIALOG') {
            handleDialogAdvance(e);
            return;
          }
          keys[keyName1] = true;
          keys[keyName2] = true;
          btn.classList.add('active');
        };
        const release = (e) => {
          e.preventDefault();
          keys[keyName1] = false;
          keys[keyName2] = false;
          btn.classList.remove('active');
        };

        // Pointer events are the modern standard to fix touch + mouse stutter issues
        btn.addEventListener('pointerdown', press);
        btn.addEventListener('pointerup', release);
        btn.addEventListener('pointerleave', release);
        btn.addEventListener('pointercancel', release);

        // Prevent default touch actions (like scrolling) strictly on the buttons
        btn.addEventListener('touchstart', (e) => e.preventDefault(), {
          passive: false,
        });
      };

      setupDpad('btn-up', 'w', 'ArrowUp');
      setupDpad('btn-down', 's', 'ArrowDown');
      setupDpad('btn-left', 'a', 'ArrowLeft');
      setupDpad('btn-right', 'd', 'ArrowRight');

      // Buttons
      document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        uiBar.classList.remove('hidden');
        currentLevel = 0;
        totalBeansCollected = 0;
        lives = 5;
        bossSpawned = false;
        loadLevel(currentLevel);
        gameLoop();
      });

      document
        .getElementById('next-level-btn')
        .addEventListener('click', () => {
          transitionScreen.classList.add('hidden');
          currentLevel++;
          loadLevel(currentLevel);
        });

      // Reliable close function
      function closeGame() {
        try {
          window.close();
        } catch (e) {}

        // If window.close is blocked by the browser, show a clean message over everything
        document.body.innerHTML = `
          <div style='display:flex; height:100vh; width:100vw; justify-content:center; align-items:center; background:#1a1a1a; color:#4ade80; font-family:"Press Start 2P", cursive; text-align:center; padding: 20px; line-height: 1.8; flex-direction: column;'>
            <h1>THANK YOU FOR PLAYING!</h1>
            <p style='color:#fff; font-size: 12px; margin-top: 30px;'>You may now close this browser tab.</p>
          </div>
        `;
      }

      document.getElementById('exit-btn').addEventListener('click', closeGame);
      document
        .getElementById('game-over-exit-btn')
        .addEventListener('click', closeGame);

      document.getElementById('try-again-btn').addEventListener('click', () => {
        gameOverScreen.classList.add('hidden');
        uiBar.classList.remove('hidden');
        currentLevel = 0;
        totalBeansCollected = 0;
        lives = 5;
        bossSpawned = false;
        loadLevel(currentLevel);
        gameState = 'PLAYING';
      });

      // Precise Box Collision using Hitboxes
      function checkCollision(obj1, obj2) {
        const r1 = {
          x: obj1.x + (obj1.hitbox ? obj1.hitbox.xOffset : 0),
          y: obj1.y + (obj1.hitbox ? obj1.hitbox.yOffset : 0),
          w: obj1.hitbox ? obj1.hitbox.w : obj1.size,
          h: obj1.hitbox ? obj1.hitbox.h : obj1.size,
        };
        const r2 = {
          x: obj2.x + (obj2.hitbox ? obj2.hitbox.xOffset : 0),
          y: obj2.y + (obj2.hitbox ? obj2.hitbox.yOffset : 0),
          w: obj2.hitbox ? obj2.hitbox.w : obj2.size,
          h: obj2.hitbox ? obj2.hitbox.h : obj2.size,
        };
        return (
          r1.x < r2.x + r2.w &&
          r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h &&
          r1.y + r1.h > r2.y
        );
      }

      function update() {
        if (gameState !== 'PLAYING') return;

        if (player.invincible) {
          player.invincibleTimer--;
          if (player.invincibleTimer <= 0) {
            player.invincible = false;
          }
        }

        let dx = 0,
          dy = 0;
        if (keys.w || keys.ArrowUp) dy -= player.speed;
        if (keys.s || keys.ArrowDown) dy += player.speed;
        if (keys.a || keys.ArrowLeft) dx -= player.speed;
        if (keys.d || keys.ArrowRight) dx += player.speed;

        // Player Direction State
        if (dy < 0) player.direction = 'up';
        else if (dy > 0) player.direction = 'down';
        else if (dx < 0) player.direction = 'left';
        else if (dx > 0) player.direction = 'right';

        if (dx !== 0 && dy !== 0) {
          dx *= 0.707;
          dy *= 0.707;
        }

        let nextX = player.x + dx;
        let nextY = player.y + dy;

        // Keep inside bounds
        if (nextX < 0) nextX = 0;
        if (nextY < 0) nextY = 0;
        if (nextX + player.size > canvas.width)
          nextX = canvas.width - player.size;
        if (nextY + player.size > canvas.height)
          nextY = canvas.height - player.size;

        // Scenery & Static Counter Collision (Solid objects)
        let hitX = false,
          hitY = false;
        const solids = [
          ...obstacles.filter((o) => o.type === 'static_counter'),
          ...scenery,
        ];

        for (let s of solids) {
          if (checkCollision({ ...player, x: nextX }, s)) hitX = true;
          if (checkCollision({ ...player, y: nextY }, s)) hitY = true;
        }

        if (!hitX) player.x = nextX;
        if (!hitY) player.y = nextY;

        for (let obs of obstacles) {
          if (obs.type === 'static_counter') continue;

          if (obs.fading) {
            obs.opacity -= 0.02;
            if (obs.opacity <= 0) obs.dead = true;
          }

          if (obs.type === 'random' || obs.type === 'boss_chase') {
            if (obs.type === 'boss_chase') {
              // Boss chases the player
              let angle = Math.atan2(player.y - obs.y, player.x - obs.x);
              obs.dx = Math.cos(angle) * obs.speed;
              obs.dy = Math.sin(angle) * obs.speed;

              // Animate the bat swing
              obs.animTimer = (obs.animTimer || 0) + 1;

              // Update direction based on velocity
              if (Math.abs(obs.dy) > Math.abs(obs.dx)) {
                obs.direction = obs.dy > 0 ? 'down' : 'up';
              } else {
                obs.direction = obs.dx > 0 ? 'right' : 'left';
              }

              // Boss Dialog Logic
              obs.bossTextTimer = (obs.bossTextTimer || 0) - 1;
              if (obs.bossTextTimer <= 0) {
                const phrases = [
                  ['halika ditoo', 'maam jaacck!'],
                  ['andyan nako takbo!'],
                  ['papaluin na kita'],
                  ['penge ng kapeee!'],
                ];
                obs.currentBossText =
                  phrases[Math.floor(Math.random() * phrases.length)];
                obs.bossTextTimer = 180; // Show a new phrase roughly every 3 seconds
              }
            } else {
              // Random Wander Logic
              obs.timer--;
              if (obs.timer <= 0) {
                const angle = Math.random() * Math.PI * 2;
                obs.dx = Math.cos(angle) * obs.speed;
                obs.dy = Math.sin(angle) * obs.speed;
                obs.timer = Math.floor(Math.random() * 60) + 30; // 0.5 to 1.5 secs

                // Update direction based on velocity
                if (Math.abs(obs.dy) > Math.abs(obs.dx)) {
                  obs.direction = obs.dy > 0 ? 'down' : 'up';
                } else {
                  obs.direction = obs.dx > 0 ? 'right' : 'left';
                }
              }
            }

            obs.x += obs.dx;
            obs.y += obs.dy;

            // Keep enemies in bounds
            if (obs.x <= obs.minX || obs.x + obs.size >= obs.maxX) obs.dx *= -1;
            if (obs.y <= obs.minY || obs.y + obs.size >= obs.maxY) obs.dy *= -1;
          }

          // Hit by moving obstacle
          if (
            checkCollision(player, obs) &&
            !player.isHit &&
            !player.invincible &&
            !obs.fading &&
            !obs.dead
          ) {
            player.isHit = true;
            lives--;
            updateUI();
            playDamageSound();

            if (lives <= 0) {
              stopMusic();
              startDialog(
                [
                  {
                    name: 'Jacky',
                    text: 'Oh no! I lost all my coffee cups...',
                  },
                ],
                () => {
                  gameState = 'GAMEOVER';
                  uiBar.classList.add('hidden');
                  gameOverScreen.classList.remove('hidden');
                },
              );
            } else {
              // Main Character Random "Ouch!" Dialog
              const hitPhrases = ['aray!', 'Jusko, sakit.', 'ano na?'];
              const randomHit =
                hitPhrases[Math.floor(Math.random() * hitPhrases.length)];
              startDialog(
                [{ name: 'Jacky', text: `${randomHit} (${lives} left)` }],
                () => {
                  // Respawn player at the start of the current room without resetting the room
                  player.x = levels[currentLevel].startX;
                  player.y = levels[currentLevel].startY;
                  player.direction = 'down';
                  player.isHit = false;
                  player.invincible = true;
                  player.invincibleTimer = 120; // 2 seconds of invincibility
                },
              );
            }
            return; // Stop updating frame
          }
        }

        // Clean up dead obstacles
        obstacles = obstacles.filter((o) => !o.dead);

        let levelComplete = true;
        let uncollectedCount = 0;

        for (let bean of beans) {
          if (!bean.collected) {
            if (checkCollision(player, bean)) {
              bean.collected = true;
              totalBeansCollected++;
              updateUI();
            } else {
              levelComplete = false;
              uncollectedCount++;
            }
          }
        }

        // BOSS LEAH Trigger (Room 3, exactly 3 beans left uncollected out of 11 total for this room)
        if (
          currentLevel === 2 &&
          uncollectedCount <= 3 &&
          !bossSpawned &&
          !player.exitActive
        ) {
          bossSpawned = true;
          // Remove other wandering enemies
          obstacles = obstacles.filter((o) => o.type === 'static_counter');
          // Spawn Boss Leah (slower speed, with animation timer)
          obstacles.push({
            x: 250,
            y: 50,
            size: 72,
            dx: 0,
            dy: 0,
            speed: 0.7,
            sprite: sprLeahDown1,
            animTimer: 0,
            direction: 'down',
            type: 'boss_chase',
            timer: 0,
            minX: 20,
            maxX: 550,
            minY: 20,
            maxY: 350,
            hitbox: { xOffset: 16, yOffset: 16, w: 40, h: 40 },
            bossTextTimer: 0,
            opacity: 1.0,
            fading: false,
            dead: false,
          });
          // Trigger earthquake screen shake
          screenShake = 25;

          // Switch to Scary Boss Music
          startBossMusic();

          // Show Boss Warning
          startDialog([
            {
              name: 'WARNING',
              text: 'Warning! BOSS LEAH IS HERE, MAG INGAT IKAW SA BUHAY MO PO MAAM JACK, OPO, KASI WALA PA AKONG TULOOG.',
            },
          ]);
          return;
        }

        if (levelComplete && beans.length > 0 && currentLevel < 3) {
          if (!player.exitActive) {
            player.exitActive = true;

            // Trigger slow death/fading for all moving enemies and boss
            obstacles.forEach((o) => {
              if (o.type !== 'static_counter') o.fading = true;
            });

            startDialog([
              {
                name: 'Jacky',
                text: 'Got them all! I need to head to the exit door!',
              },
            ]);
          }
        }

        if (player.exitActive) {
          let ex = levels[currentLevel].exit;
          let doorBox = {
            x: ex.x,
            y: ex.y,
            size: 48,
            hitbox: { xOffset: 0, yOffset: 0, w: 48, h: 48 },
          };
          if (checkCollision(player, doorBox)) {
            player.exitActive = false;
            gameState = 'TRANSITION';
            transitionScreen.classList.remove('hidden');
          }
        }

        if (currentLevel === 3) {
          // Trigger box strictly localized right around the friends group
          const friendTriggerBox = {
            x: 380,
            y: 110,
            size: 100,
            hitbox: { xOffset: 0, yOffset: 0, w: 120, h: 200 },
          };

          if (checkCollision(player, friendTriggerBox)) {
            // Start ending dialog sequence
            stopMusic();
            startDialog(
              [
                {
                  name: 'Jose (Husband)',
                  text: 'Surprise, Love! Happy Birthday!',
                },
                {
                  name: 'Don Joseph',
                  text: 'sorry ate jack natagalan ako kanina.. nag gawa kasi ako kanina ng pang paninda ko.. bili na din kayo , oreo float, mango float at banana yema! murang mura!',
                },
                {
                  name: 'Jay',
                  text: 'hello maam jack ginawa ko to kanina habang nag ccooffee tayo.',
                },
              ],
              () => {
                // Show final win screen after dialog
                uiBar.classList.add('hidden');
                winScreen.classList.remove('hidden');
                gameState = 'WIN';
              },
            );
          }
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Apply screen shake (earthquake effect)
        let isShaking = false;
        if (screenShake > 0) {
          isShaking = true;
          ctx.save();
          let dx = (Math.random() - 0.5) * screenShake;
          let dy = (Math.random() - 0.5) * screenShake;
          ctx.translate(dx, dy);
          screenShake *= 0.92; // gradual decay of earthquake
          if (screenShake < 0.5) screenShake = 0;
        }

        // Draw Wood Floor Pattern
        ctx.fillStyle = '#2b1d14';
        for (let i = 0; i < canvas.width; i += 48) {
          ctx.fillRect(i, 0, 2, canvas.height);
        }
        for (let i = 0; i < canvas.height; i += 48) {
          ctx.fillRect(0, i, canvas.width, 2);
        }

        // Draw Scenery (Plants, Tables, Chairs)
        for (let s of scenery) {
          drawSprite(s.sprite, s.x, s.y, s.size);
        }

        // Draw Static Objects
        for (let obs of obstacles) {
          if (obs.type === 'static_counter') {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(obs.x, obs.y, obs.hitbox.w, obs.hitbox.h);
            ctx.strokeStyle = '#3e1f08';
            ctx.lineWidth = 4;
            ctx.strokeRect(obs.x, obs.y, obs.hitbox.w, obs.hitbox.h);
            ctx.fillStyle = '#6b340e';
            for (let i = obs.x + 20; i < obs.x + obs.hitbox.w; i += 40) {
              ctx.fillRect(i, obs.y, 2, obs.hitbox.h);
            }
          }
        }

        // Draw Entities
        for (let friend of friends)
          drawSprite(friend.sprite, friend.x, friend.y, friend.size);
        for (let bean of beans)
          if (!bean.collected) drawSprite(sprBean, bean.x, bean.y, bean.size);
        for (let obs of obstacles) {
          if (obs.type !== 'static_counter') {
            if (obs.opacity !== undefined)
              ctx.globalAlpha = Math.max(0, obs.opacity);

            let flipObstacle = false;
            let currentSpr = obs.sprite;

            // BOSS LEAH DIRECTIONAL DRAWING
            if (obs.type === 'boss_chase') {
              let isFrame2 = obs.animTimer % 30 >= 15;
              if (obs.direction === 'up')
                currentSpr = isFrame2 ? sprLeahUp2 : sprLeahUp1;
              else if (obs.direction === 'left') {
                currentSpr = isFrame2 ? sprLeahSide2 : sprLeahSide1;
                flipObstacle = true;
              } else if (obs.direction === 'right') {
                currentSpr = isFrame2 ? sprLeahSide2 : sprLeahSide1;
                flipObstacle = false;
              } else currentSpr = isFrame2 ? sprLeahDown2 : sprLeahDown1;
            }
            // BARISTA DIRECTIONAL DRAWING
            else if (
              obs.sprite === sprBaristaDown ||
              obs.sprite === sprBaristaUp ||
              obs.sprite === sprBaristaSide
            ) {
              if (obs.direction === 'up') currentSpr = sprBaristaUp;
              else if (obs.direction === 'left') {
                currentSpr = sprBaristaSide;
                flipObstacle = true;
              } else if (obs.direction === 'right') {
                currentSpr = sprBaristaSide;
                flipObstacle = false;
              } else currentSpr = sprBaristaDown;
            }

            drawSprite(currentSpr, obs.x, obs.y, obs.size, flipObstacle);

            // Draw Boss Dialog Bubble
            if (obs.type === 'boss_chase' && obs.currentBossText) {
              ctx.fillStyle = 'white';
              ctx.strokeStyle = '#000';
              ctx.lineWidth = 2;
              ctx.font = '8px "Press Start 2P"';
              ctx.textAlign = 'center';

              let bubbleWidth = 200;
              let bubbleHeight = obs.currentBossText.length * 12 + 10;
              let bubbleX = obs.x + obs.size / 2 - bubbleWidth / 2;
              let bubbleY = obs.y - bubbleHeight - 10;

              // Draw Background
              ctx.fillRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
              ctx.strokeRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);

              // Draw Tail
              ctx.beginPath();
              ctx.moveTo(obs.x + obs.size / 2 - 5, bubbleY + bubbleHeight);
              ctx.lineTo(obs.x + obs.size / 2, bubbleY + bubbleHeight + 10);
              ctx.lineTo(obs.x + obs.size / 2 + 5, bubbleY + bubbleHeight);
              ctx.fill();
              ctx.stroke();
              ctx.closePath();

              // Draw Text
              ctx.fillStyle = '#000';
              for (let i = 0; i < obs.currentBossText.length; i++) {
                ctx.fillText(
                  obs.currentBossText[i],
                  obs.x + obs.size / 2,
                  bubbleY + 14 + i * 12,
                );
              }
            }
            ctx.globalAlpha = 1.0; // Reset global alpha for next items
          }
        }

        // Draw Player (with direction tracking and invincibility blinking)
        if (!player.invincible || Math.floor(Date.now() / 150) % 2 === 0) {
          let currentSpr = sprJackyDown;
          let flip = false;
          if (player.direction === 'up') currentSpr = sprJackyUp;
          else if (player.direction === 'left') {
            currentSpr = sprJackySide;
            flip = true;
          } else if (player.direction === 'right') {
            currentSpr = sprJackySide;
            flip = false;
          }

          drawSprite(currentSpr, player.x, player.y, player.size, flip);
        }

        // Draw Exit Door & Arrow
        if (player.exitActive && currentLevel < 3) {
          let ex = levels[currentLevel].exit;
          drawSprite(sprDoor, ex.x, ex.y, 48);

          if (Math.floor(Date.now() / 300) % 2 === 0) {
            if (ex.type === 'right') {
              drawSpriteRotated(sprArrow, ex.x - 48, ex.y, 48, Math.PI / 2);
            } else if (ex.type === 'bottom') {
              drawSpriteRotated(sprArrow, ex.x, ex.y - 48, 48, Math.PI);
            } else {
              drawSprite(sprArrow, ex.x, ex.y + 48, 48); // top
            }
          }
        }

        if (isShaking) {
          ctx.restore();
        }
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      // Initial draw to render background before start
      draw();
    </script>
  </body>
</html>
