<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Jacky's Birthday Coffee Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a1a1a;
        font-family: 'Press Start 2P', cursive;
        touch-action: none;
        color: white;
      }
      #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(#1e3f20, #0a1f0d);
      }
      canvas {
        background-color: #3b2818;
        border: 6px solid #000;
        box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.5);
        image-rendering: pixelated;
        max-width: 95%;
        max-height: 60vh;
      }

      /* Pixel Art UI Styles */
      .pixel-panel {
        background-color: #006241;
        border: 4px solid #fff;
        box-shadow: 6px 6px 0px #000;
        padding: 20px;
        text-align: center;
      }
      .pixel-btn {
        background-color: #2b1d14;
        border: 4px solid #fff;
        box-shadow: 4px 4px 0px #000;
        color: white;
        padding: 15px 20px;
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        line-height: 1.5;
        text-transform: uppercase;
        cursor: pointer;
        margin-top: 20px;
      }
      .pixel-btn:active {
        transform: translate(4px, 4px);
        box-shadow: 0px 0px 0px #000;
      }

      /* Mobile D-Pad Styles */
      #dpad {
        display: grid;
        grid-template-columns: repeat(3, 60px);
        grid-template-rows: repeat(3, 60px);
        gap: 5px;
        margin-top: 15px;
      }
      .dpad-btn {
        background-color: #d4b895;
        border: 4px solid #000;
        box-shadow: 4px 4px 0px #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #000;
        user-select: none;
        cursor: pointer;
        z-index: 10;
      }
      .dpad-btn:active,
      .dpad-btn.active {
        transform: translate(4px, 4px);
        box-shadow: 0px 0px 0px #000;
        background-color: #b09676;
      }
      #btn-up {
        grid-column: 2;
        grid-row: 1;
      }
      #btn-left {
        grid-column: 1;
        grid-row: 2;
      }
      #btn-right {
        grid-column: 3;
        grid-row: 2;
      }
      #btn-down {
        grid-column: 2;
        grid-row: 3;
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
      }
      .hidden {
        display: none !important;
      }

      #ui-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 30px;
        z-index: 5;
        font-size: 12px;
        color: white;
        text-shadow: 2px 2px 0px #000;
      }

      .title-text {
        color: #4ade80;
        text-shadow: 4px 4px 0px #000;
        font-size: 24px;
        line-height: 1.5;
        margin-bottom: 20px;
      }
      .body-text {
        font-size: 10px;
        line-height: 1.8;
        max-width: 400px;
        margin-bottom: 20px;
        color: #e5e7eb;
      }

      /* Dialog Box (Pokemon Style) */
      #dialog-box {
        position: absolute;
        bottom: 20%;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 500px;
        background-color: #f8f9fa;
        border: 6px solid #2b1d14;
        box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 15px;
        z-index: 20;
        color: #000;
        cursor: pointer;
      }
      #dialog-name {
        color: #006241;
        font-size: 12px;
        margin-bottom: 10px;
        text-transform: uppercase;
        text-shadow: 1px 1px 0px #ccc;
      }
      #dialog-text {
        font-size: 10px;
        line-height: 1.6;
      }
      .dialog-prompt {
        text-align: right;
        font-size: 8px;
        color: #888;
        margin-top: 10px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <div id="ui-bar" class="hidden">
        <span id="level-display">RM:1</span>
        <span id="bean-display">BEANS:0/24</span>
      </div>

      <canvas id="gameCanvas" width="600" height="400"></canvas>

      <!-- Dialog UI -->
      <div id="dialog-box" class="hidden">
        <div id="dialog-name" class="font-bold">Name</div>
        <div id="dialog-text">Text goes here...</div>
        <div class="dialog-prompt">Tap to continue ▼</div>
      </div>

      <!-- Mobile Controls -->
      <div id="dpad">
        <div class="dpad-btn" id="btn-up">▲</div>
        <div class="dpad-btn" id="btn-left">◀</div>
        <div class="dpad-btn" id="btn-right">▶</div>
        <div class="dpad-btn" id="btn-down">▼</div>
      </div>

      <!-- Start Screen -->
      <div id="start-screen" class="overlay">
        <div class="pixel-panel">
          <h1 class="title-text">JACKY'S<br />COFFEE RUN</h1>
          <p class="body-text">
            Collect 24 coffee beans to find your surprise! Dodge the obstacles!
          </p>
          <button id="start-btn" class="pixel-btn">START GAME</button>
        </div>
      </div>

      <!-- Level Transition Screen -->
      <div id="transition-screen" class="overlay hidden">
        <div class="pixel-panel">
          <h1 class="title-text" id="transition-title">ROOM CLEARED!</h1>
          <p class="body-text">You're getting closer to the surprise!</p>
          <button id="next-level-btn" class="pixel-btn">ENTER NEXT ROOM</button>
        </div>
      </div>

      <!-- Win Screen -->
      <div id="win-screen" class="overlay hidden">
        <div class="pixel-panel">
          <h1 class="title-text" style="color: #fde047; font-size: 20px">
            Happy Birday Jacky!
          </h1>
          <p
            class="body-text"
            style="
              font-size: 12px;
              color: #86efac;
              margin-bottom: 30px;
              line-height: 2;
            ">
            from ICLC FRIENDS<br />and Coffee buddies!
          </p>
          <button
            id="exit-btn"
            class="pixel-btn"
            style="background-color: #991b1b">
            EXIT GAME
          </button>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      // UI Elements
      const startScreen = document.getElementById('start-screen');
      const transitionScreen = document.getElementById('transition-screen');
      const winScreen = document.getElementById('win-screen');
      const uiBar = document.getElementById('ui-bar');
      const beanDisplay = document.getElementById('bean-display');
      const levelDisplay = document.getElementById('level-display');
      const dialogBox = document.getElementById('dialog-box');
      const dialogName = document.getElementById('dialog-name');
      const dialogText = document.getElementById('dialog-text');

      let gameState = 'START'; // START, PLAYING, DIALOG, TRANSITION, WIN
      let currentLevel = 0;
      let totalBeansCollected = 0;
      const keys = {
        w: false,
        a: false,
        s: false,
        d: false,
        ArrowUp: false,
        ArrowDown: false,
        ArrowLeft: false,
        ArrowRight: false,
      };

      // --- DIALOG SYSTEM ---
      let dialogQueue = [];
      let onDialogComplete = null;

      function startDialog(dialogs, callback) {
        dialogQueue = [...dialogs];
        onDialogComplete = callback;
        gameState = 'DIALOG';
        keys.w =
          keys.a =
          keys.s =
          keys.d =
          keys.ArrowUp =
          keys.ArrowDown =
          keys.ArrowLeft =
          keys.ArrowRight =
            false; // Stop movement
        showNextDialogLine();
      }

      function showNextDialogLine() {
        if (dialogQueue.length === 0) {
          dialogBox.classList.add('hidden');
          gameState = 'PLAYING';
          if (onDialogComplete) onDialogComplete();
          return;
        }
        const line = dialogQueue.shift();
        dialogBox.classList.remove('hidden');
        dialogName.innerText = line.name || 'Jacky';
        dialogText.innerText = line.text;
      }

      // Tap anywhere or press any key during dialog to advance
      const handleDialogAdvance = (e) => {
        if (gameState === 'DIALOG') {
          e.preventDefault();
          showNextDialogLine();
        }
      };
      document
        .getElementById('game-container')
        .addEventListener('mousedown', handleDialogAdvance);
      document
        .getElementById('game-container')
        .addEventListener('touchstart', handleDialogAdvance, {
          passive: false,
        });

      // --- PIXEL ART ENGINE ---
      const colors = {
        0: '#000000', // Black Outline
        1: '#ffccaa', // Skin
        2: '#4a2511', // Dark Brown (Jacky's Hair)
        3: '#00704A', // Starbucks Green
        4: '#225588', // Jeans Blue
        5: '#ffffff', // White
        6: '#d4af37', // Blonde hair
        7: '#8c593b', // Bean dark / wood
        8: '#aaaaaa', // Gray Cart
        9: '#ff6699', // Pink shirt (Jacky)
        a: '#87ceeb', // Glasses frame (Light Blue)
        b: '#333333', // Husband suit (Dark Gray)
        c: '#ff9900', // Candle flame
        p: '#2e8b57', // Plant green
        '.': 'transparent',
      };

      // Jacky Sprite Updated: Longer hair & prominent glasses
      const sprJacky = [
        '............',
        '...000000...',
        '..02222220..',
        '.0221111220.',
        '.0aa1111aa0.', // Larger, brighter glasses
        '.0a111111a0.',
        '.0222222220.',
        '.0209999020.', // Hair overlapping the shirt
        '.0209999020.',
        '..02444420..',
        '...040040...',
        '...00..00...',
      ];

      const sprBean = [
        '............',
        '............',
        '....0000....',
        '...077770...',
        '..07722770..',
        '..07227770..',
        '..07777770..',
        '...000000...',
        '............',
        '............',
        '............',
        '............',
      ];

      const sprCart = [
        '............',
        '...000000...',
        '..08888880..',
        '.0888888880.',
        '.0888888880.',
        '.0000000000.',
        '....0..0....',
        '....0..0....',
        '............',
        '............',
        '............',
        '............',
      ];

      const sprCup = [
        '............',
        '............',
        '....0000....',
        '...055550...',
        '..01111110..',
        '..055555500.',
        '...055550.0.',
        '...0333300..',
        '....0000....',
        '............',
        '............',
        '............',
      ];

      const sprBarista = [
        '...000000...',
        '..03333330..',
        '..00333300..',
        '...011110...',
        '...010010...',
        '...011110...',
        '..00055000..',
        '.0103333010.',
        '.0003333000.',
        '...044440...',
        '...00..00...',
        '............',
      ];

      const sprHusband = [
        '...000000...',
        '..02222220..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '...000000...',
        '..00b55b00..',
        '.010bbbb010.',
        '.000bbbb000.',
        '...0bbbb0...',
        '...00..00...',
        '............',
      ];

      const sprFriend1 = [
        '............',
        '...000000...',
        '..06666660..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '..00888800..',
        '.0108888010.',
        '.0004444000.',
        '...044440...',
        '...00..00...',
        '............',
      ];

      const sprFriend2 = [
        '............',
        '...000000...',
        '..02222220..',
        '..01111110..',
        '..01011010..',
        '...011110...',
        '..00cccc00..',
        '.010cccc010.',
        '.000bbbb000.',
        '...0bbbb0...',
        '...00..00...',
        '............',
      ];

      const sprPlant = [
        '............',
        '....pppp....',
        '...pppppp...',
        '..pppppppp..',
        '...pppppp...',
        '....pppp....',
        '.....22.....',
        '....0000....',
        '...088880...',
        '...088880...',
        '....0000....',
        '............',
      ];

      const sprTable = [
        '............',
        '............',
        '............',
        '.0000000000.',
        '.0777777770.',
        '.0777777770.',
        '.0000000000.',
        '...02..20...',
        '...02..20...',
        '...02..20...',
        '...00..00...',
        '............',
      ];

      function drawSprite(spriteArray, x, y, size, flipX = false) {
        const pixelSize = size / 12; // 12x12 grid
        for (let row = 0; row < 12; row++) {
          for (let col = 0; col < 12; col++) {
            const char = spriteArray[row][col];
            if (char !== '.') {
              ctx.fillStyle = colors[char];
              let px = flipX ? 11 - col : col;
              ctx.fillRect(
                x + px * pixelSize,
                y + row * pixelSize,
                pixelSize,
                pixelSize,
              );
            }
          }
        }
      }

      // --- GAME ENTITIES & LOGIC ---

      const player = {
        x: 50,
        y: 200,
        size: 48,
        speed: 4,
        sprite: sprJacky,
        facingRight: true,
        hitbox: { xOffset: 12, yOffset: 16, w: 24, h: 24 },
      };

      let beans = [];
      let obstacles = [];
      let scenery = [];
      let friends = [];

      const levels = [
        {
          name: 'Outside Cafe',
          intro: [
            {
              name: 'Jacky',
              text: 'Ah, the coffee shop! I need to collect the 8 coffee beans scattered outside first.',
            },
            {
              name: 'Jacky',
              text: 'I better watch out for those sliding shopping carts!',
            },
          ],
          startX: 50,
          startY: 200,
          beans: [
            { x: 150, y: 100 },
            { x: 250, y: 100 },
            { x: 350, y: 100 },
            { x: 450, y: 100 },
            { x: 150, y: 300 },
            { x: 250, y: 300 },
            { x: 350, y: 300 },
            { x: 450, y: 300 },
          ],
          obstacles: [
            {
              x: 200,
              y: 50,
              size: 48,
              dx: 0,
              dy: 3,
              sprite: sprCart,
              type: 'bounceY',
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
            {
              x: 400,
              y: 350,
              size: 48,
              dx: 0,
              dy: -3,
              sprite: sprCart,
              type: 'bounceY',
              minY: 50,
              maxY: 350,
              hitbox: { xOffset: 8, yOffset: 8, w: 32, h: 32 },
            },
          ],
          scenery: [
            { x: 20, y: 20, size: 48, sprite: sprPlant },
            { x: 530, y: 20, size: 48, sprite: sprPlant },
            { x: 20, y: 330, size: 48, sprite: sprPlant },
            { x: 530, y: 330, size: 48, sprite: sprPlant },
          ],
          friends: [],
        },
        {
          name: 'The Lounge',
          intro: [
            {
              name: 'Jacky',
              text: 'The restaurant lounge. More beans to collect here!',
            },
            {
              name: 'Jacky',
              text: 'Those giant hot coffee cups look dangerous. Better dodge them.',
            },
          ],
          startX: 50,
          startY: 200,
          beans: [
            { x: 100, y: 50 },
            { x: 200, y: 50 },
            { x: 300, y: 50 },
            { x: 400, y: 50 },
            { x: 100, y: 350 },
            { x: 200, y: 350 },
            { x: 300, y: 350 },
            { x: 400, y: 350 },
          ],
          obstacles: [
            {
              x: 100,
              y: 150,
              size: 48,
              dx: 4,
              dy: 0,
              sprite: sprCup,
              type: 'bounceX',
              minX: 100,
              maxX: 500,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
            {
              x: 500,
              y: 250,
              size: 48,
              dx: -4,
              dy: 0,
              sprite: sprCup,
              type: 'bounceX',
              minX: 100,
              maxX: 500,
              hitbox: { xOffset: 12, yOffset: 12, w: 24, h: 24 },
            },
          ],
          scenery: [
            { x: 150, y: 200, size: 48, sprite: sprTable },
            { x: 350, y: 200, size: 48, sprite: sprTable },
            { x: 250, y: 80, size: 48, sprite: sprPlant },
            { x: 250, y: 300, size: 48, sprite: sprPlant },
          ],
          friends: [],
        },
        {
          name: 'The Counter',
          intro: [
            {
              name: 'Jacky',
              text: 'The main counter! I have to walk around it to get the last beans.',
            },
            {
              name: 'Jacky',
              text: "The baristas are walking around randomly making orders. Let's take it slow.",
            },
          ],
          startX: 50,
          startY: 200,
          beans: [
            { x: 150, y: 50 },
            { x: 250, y: 50 },
            { x: 350, y: 50 },
            { x: 450, y: 50 },
            { x: 150, y: 300 },
            { x: 250, y: 300 },
            { x: 350, y: 300 },
            { x: 450, y: 300 },
          ],
          obstacles: [
            // Randomly wandering enemies (slower)
            {
              x: 150,
              y: 100,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.5,
              sprite: sprBarista,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            {
              x: 450,
              y: 300,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.5,
              sprite: sprBarista,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            {
              x: 300,
              y: 250,
              size: 48,
              dx: 0,
              dy: 0,
              speed: 1.5,
              sprite: sprBarista,
              type: 'random',
              timer: 0,
              minX: 50,
              maxX: 500,
              minY: 30,
              maxY: 350,
              hitbox: { xOffset: 12, yOffset: 8, w: 24, h: 36 },
            },
            // Static Counter (Acts as an obstacle block)
            {
              x: 150,
              y: 170,
              size: 48,
              dx: 0,
              dy: 0,
              type: 'static_counter',
              hitbox: { xOffset: 0, yOffset: 0, w: 300, h: 60 },
            },
          ],
          scenery: [
            { x: 30, y: 20, size: 48, sprite: sprPlant },
            { x: 520, y: 320, size: 48, sprite: sprPlant },
          ],
          friends: [],
        },
        {
          name: 'VIP Room',
          intro: [
            { name: 'Jacky', text: "Wait... the VIP room? Who's in here?" },
          ],
          startX: 50,
          startY: 200,
          beans: [],
          obstacles: [],
          scenery: [
            { x: 100, y: 50, size: 48, sprite: sprPlant },
            { x: 100, y: 300, size: 48, sprite: sprPlant },
            { x: 450, y: 50, size: 48, sprite: sprPlant },
            { x: 450, y: 300, size: 48, sprite: sprPlant },
            { x: 380, y: 150, size: 48, sprite: sprTable },
          ],
          friends: [
            { name: 'Jose', x: 450, y: 200, size: 48, sprite: sprHusband },
            { name: 'DJ', x: 400, y: 130, size: 48, sprite: sprFriend1 },
            { name: 'Jay', x: 400, y: 270, size: 48, sprite: sprFriend2 },
          ],
        },
      ];

      function loadLevel(levelIndex) {
        const lvl = levels[levelIndex];
        player.x = lvl.startX;
        player.y = lvl.startY;

        beans = lvl.beans.map((b) => ({
          ...b,
          size: 24,
          collected: false,
          hitbox: { xOffset: 0, yOffset: 0, w: 24, h: 24 },
        }));
        obstacles = lvl.obstacles.map((o) => ({ ...o }));
        scenery = lvl.scenery ? lvl.scenery.map((s) => ({ ...s })) : [];
        friends = lvl.friends.map((f) => ({
          ...f,
          hitbox: { xOffset: 0, yOffset: 0, w: 48, h: 48 },
        }));

        levelDisplay.innerText = `RM:${levelIndex + 1}`;
        updateUI();

        // Start level intro dialog
        if (lvl.intro && lvl.intro.length > 0) {
          startDialog(lvl.intro, null);
        }
      }

      function updateUI() {
        beanDisplay.innerText = `BEANS:${totalBeansCollected}/24`;
      }

      // Input Handling
      window.addEventListener('keydown', (e) => {
        if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
        if (gameState === 'DIALOG' && (e.key === ' ' || e.key === 'Enter'))
          handleDialogAdvance(e);
      });
      window.addEventListener('keyup', (e) => {
        if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
      });

      const setupDpad = (btnId, keyName1, keyName2) => {
        const btn = document.getElementById(btnId);
        const press = (e) => {
          e.preventDefault();
          if (gameState === 'DIALOG') {
            handleDialogAdvance(e);
            return;
          }
          keys[keyName1] = true;
          keys[keyName2] = true;
          btn.classList.add('active');
        };
        const release = (e) => {
          e.preventDefault();
          keys[keyName1] = false;
          keys[keyName2] = false;
          btn.classList.remove('active');
        };
        btn.addEventListener('touchstart', press, { passive: false });
        btn.addEventListener('touchend', release);
        btn.addEventListener('mousedown', press);
        btn.addEventListener('mouseup', release);
        btn.addEventListener('mouseleave', release);
      };

      setupDpad('btn-up', 'w', 'ArrowUp');
      setupDpad('btn-down', 's', 'ArrowDown');
      setupDpad('btn-left', 'a', 'ArrowLeft');
      setupDpad('btn-right', 'd', 'ArrowRight');

      // Buttons
      document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        uiBar.classList.remove('hidden');
        currentLevel = 0;
        totalBeansCollected = 0;
        loadLevel(currentLevel);
        gameLoop();
      });

      document
        .getElementById('next-level-btn')
        .addEventListener('click', () => {
          transitionScreen.classList.add('hidden');
          currentLevel++;
          loadLevel(currentLevel);
        });

      document.getElementById('exit-btn').addEventListener('click', () => {
        // Exit game (reloads page to simulate closing/restarting)
        window.location.reload();
      });

      // Precise Box Collision using Hitboxes
      function checkCollision(obj1, obj2) {
        const r1 = {
          x: obj1.x + (obj1.hitbox ? obj1.hitbox.xOffset : 0),
          y: obj1.y + (obj1.hitbox ? obj1.hitbox.yOffset : 0),
          w: obj1.hitbox ? obj1.hitbox.w : obj1.size,
          h: obj1.hitbox ? obj1.hitbox.h : obj1.size,
        };
        const r2 = {
          x: obj2.x + (obj2.hitbox ? obj2.hitbox.xOffset : 0),
          y: obj2.y + (obj2.hitbox ? obj2.hitbox.yOffset : 0),
          w: obj2.hitbox ? obj2.hitbox.w : obj2.size,
          h: obj2.hitbox ? obj2.hitbox.h : obj2.size,
        };
        return (
          r1.x < r2.x + r2.w &&
          r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h &&
          r1.y + r1.h > r2.y
        );
      }

      function update() {
        if (gameState !== 'PLAYING') return;

        let dx = 0,
          dy = 0;
        if (keys.w || keys.ArrowUp) dy -= player.speed;
        if (keys.s || keys.ArrowDown) dy += player.speed;
        if (keys.a || keys.ArrowLeft) {
          dx -= player.speed;
          player.facingRight = false;
        }
        if (keys.d || keys.ArrowRight) {
          dx += player.speed;
          player.facingRight = true;
        }

        if (dx !== 0 && dy !== 0) {
          dx *= 0.707;
          dy *= 0.707;
        }

        let newPlayer = { ...player, x: player.x + dx, y: player.y + dy };

        // Keep inside bounds
        if (newPlayer.x < 0) newPlayer.x = 0;
        if (newPlayer.y < 0) newPlayer.y = 0;
        if (newPlayer.x + newPlayer.size > canvas.width)
          newPlayer.x = canvas.width - newPlayer.size;
        if (newPlayer.y + newPlayer.size > canvas.height)
          newPlayer.y = canvas.height - newPlayer.size;

        // Apply movement
        player.x = newPlayer.x;
        player.y = newPlayer.y;

        for (let obs of obstacles) {
          if (obs.type === 'static_counter') {
            // If hitting a static object, push player back out
            if (checkCollision(player, obs)) {
              player.x -= dx;
              player.y -= dy;
            }
            continue;
          }

          if (obs.type === 'random') {
            // Random Wander Logic
            obs.timer--;
            if (obs.timer <= 0) {
              const angle = Math.random() * Math.PI * 2;
              obs.dx = Math.cos(angle) * obs.speed;
              obs.dy = Math.sin(angle) * obs.speed;
              obs.timer = Math.floor(Math.random() * 60) + 30; // 0.5 to 1.5 secs
            }
            obs.x += obs.dx;
            obs.y += obs.dy;

            // Keep random enemies in bounds
            if (obs.x <= obs.minX || obs.x + obs.size >= obs.maxX) obs.dx *= -1;
            if (obs.y <= obs.minY || obs.y + obs.size >= obs.maxY) obs.dy *= -1;
          } else {
            // Normal bounce logic
            obs.x += obs.dx;
            obs.y += obs.dy;
            if (obs.type === 'bounceY') {
              if (obs.y <= obs.minY || obs.y + obs.size >= obs.maxY)
                obs.dy *= -1;
            } else if (obs.type === 'bounceX') {
              if (obs.x <= obs.minX || obs.x + obs.size >= obs.maxX)
                obs.dx *= -1;
            }
          }

          // Hit by moving obstacle
          if (checkCollision(player, obs)) {
            const levelBeans = levels[currentLevel].beans.length;
            const uncollected = beans.filter((b) => !b.collected).length;
            totalBeansCollected -= levelBeans - uncollected;
            loadLevel(currentLevel);
            return;
          }
        }

        let levelComplete = true;
        for (let bean of beans) {
          if (!bean.collected) {
            if (checkCollision(player, bean)) {
              bean.collected = true;
              totalBeansCollected++;
              updateUI();
            } else {
              levelComplete = false;
            }
          }
        }

        if (levelComplete && beans.length > 0 && currentLevel < 3) {
          gameState = 'TRANSITION';
          transitionScreen.classList.remove('hidden');
        }

        if (currentLevel === 3) {
          // Trigger box area around the friends group
          const friendTriggerBox = {
            x: 300,
            y: 100,
            size: 200,
            hitbox: { xOffset: 0, yOffset: 0, w: 250, h: 200 },
          };

          if (checkCollision(player, friendTriggerBox)) {
            // Start ending dialog sequence
            startDialog(
              [
                {
                  name: 'Jose (Husband)',
                  text: 'Surprise, honey! Happy Birthday!',
                },
                {
                  name: 'DJ',
                  text: 'We collected all these coffee beans to celebrate your special day!',
                },
                {
                  name: 'Jay',
                  text: "Let's party! We hope you love the surprise!",
                },
              ],
              () => {
                // Show final win screen after dialog
                uiBar.classList.add('hidden');
                winScreen.classList.remove('hidden');
                gameState = 'WIN';
              },
            );
          }
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw Wood Floor Pattern
        ctx.fillStyle = '#2b1d14';
        for (let i = 0; i < canvas.width; i += 48) {
          ctx.fillRect(i, 0, 2, canvas.height);
        }
        for (let i = 0; i < canvas.height; i += 48) {
          ctx.fillRect(0, i, canvas.width, 2);
        }

        // Draw Scenery (Plants, Tables)
        for (let s of scenery) {
          drawSprite(s.sprite, s.x, s.y, s.size);
        }

        // Draw Static Objects (Like the long counter in Room 3)
        for (let obs of obstacles) {
          if (obs.type === 'static_counter') {
            ctx.fillStyle = '#8B4513'; // Wood color
            ctx.fillRect(obs.x, obs.y, obs.hitbox.w, obs.hitbox.h);
            ctx.strokeStyle = '#3e1f08';
            ctx.lineWidth = 4;
            ctx.strokeRect(obs.x, obs.y, obs.hitbox.w, obs.hitbox.h);
            // Draw some lines on the counter to make it look like planks
            ctx.fillStyle = '#6b340e';
            for (let i = obs.x + 20; i < obs.x + obs.hitbox.w; i += 40) {
              ctx.fillRect(i, obs.y, 2, obs.hitbox.h);
            }
          }
        }

        // Draw Entities
        for (let friend of friends)
          drawSprite(friend.sprite, friend.x, friend.y, friend.size);
        for (let bean of beans)
          if (!bean.collected) drawSprite(sprBean, bean.x, bean.y, bean.size);
        for (let obs of obstacles) {
          if (obs.type !== 'static_counter') {
            let flipObstacle = obs.dx < 0;
            drawSprite(obs.sprite, obs.x, obs.y, obs.size, flipObstacle);
          }
        }

        // Draw Player
        drawSprite(
          player.sprite,
          player.x,
          player.y,
          player.size,
          !player.facingRight,
        );
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      // Initial draw to render background before start
      draw();
    </script>
  </body>
</html>
